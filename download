import requests

taxonKey = 3073  # æŸ¥è¯¢æ•°æ®é‡
url = f"https://api.gbif.org/v1/occurrence/search?taxonKey={taxonKey}&hasCoordinate=true&limit=0"
data = requests.get(url).json()

print("Bambusoideaeï¼ˆç«¹äºšç§‘ï¼‰æœ‰åæ ‡è®°å½•æ•° =", data["count"])

import requests
import time

#è°ƒç”¨apiä¸‹è½½èŽ·å–ä¸‹è½½æƒé™ï¼Œä¸€æ¬¡åªèƒ½èŽ·å–ä¸‰ä¸ª
USERNAME = "ukito"
PASSWORD = "Applesun000"
CREATOR  = "ukito"   # å¿…é¡»ä¸Ž USERNAME å®Œå…¨ä¸€è‡´

# æ´²åˆ«æ˜ å°„
continents = {
    
    "NORTH_AMERICA": "NorthAmerica",
    "SOUTH_AMERICA": "SouthAmerica"
}

url = "https://api.gbif.org/v1/occurrence/download/request"

download_keys = {}

for continent_key, continent_name in continents.items():
    download_request = {
        "creator": CREATOR,
        "notificationAddresses": [],
        "format": "DWCA",
        "predicate": {
            "type": "and",
            "predicates": [
                {
                    "type": "greaterThanOrEquals",
                    "key": "YEAR",
                    "value": 2015
                },
                {
                    "type": "lessThanOrEquals",
                    "key": "YEAR",
                    "value": 2022
                },
                {
                    "type": "equals",
                    "key": "TAXON_KEY",
                    "value": 3073   # Bambusoideae
                },
                {
                    "type": "equals",
                    "key": "HAS_COORDINATE",
                    "value": True
                },
                {
                    "type": "equals",
                    "key": "CONTINENT",
                    "value": continent_key
                }
            ]
        }
    }

    print(f"Submitting download request for {continent_name}...")

    r = requests.post(url, json=download_request, auth=(USERNAME, PASSWORD))

    if r.status_code != 201:
        print(f"âŒ Failed for {continent_name}:", r.status_code, r.text)
        continue

    download_key = r.text.strip()
    download_keys[continent_name] = download_key

    print(f"âœ” {continent_name} submitted successfully!")
    print("   Download key:", download_key)

    # é¿å…è§¦å‘ GBIF API é™æµ
    time.sleep(2)

print("\nAll submitted download keys:")
for k, v in download_keys.items():
    print(f"{k}: {v}")


#èŽ·å–ä¸‹è½½è¿žæŽ¥
import time
import requests

download_key = "0058123-251120083545085"

status_url = f"https://api.gbif.org/v1/occurrence/download/{download_key}"

print("Checking GBIF download status...\n")

while True:
    status = requests.get(status_url).json()
    state = status["status"]

    print("Current status:", state)

    if state == "SUCCEEDED":
        print("\nðŸŽ‰ GBIF download is ready!")
        print("Download link:")
        print(status["downloadLink"])
        break
    elif state in ["KILLED", "CANCELLED", "FAILED"]:
        print("\nâŒ Download failed:", state)
        print(status)
        break

    time.sleep(20)

#ä¸‹è½½è§£åŽ‹
 !wget -O SouthAmerica.zip https://api.gbif.org/v1/occurrence/download/request/0058124-251120083545085.zip     #åå­—å¯æ›´æ”¹
#è§£åŽ‹
import zipfile
import os

os.makedirs("SouthAmerica", exist_ok=True)

with zipfile.ZipFile("SouthAmerica.zip", "r") as z:
    z.extractall("SouthAmerica")

os.listdir("SouthAmerica")

#è½¬csvæ ¼å¼
!sed 's/\t/,/g' NorthAmerica/occurrence.txt > NorthAmerica_occurrence.csv
